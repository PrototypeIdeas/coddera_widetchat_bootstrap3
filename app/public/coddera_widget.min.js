function widget(){$("#purecloud-widget").load(host+"/coddera-widget",function(){$("#initial_card_widget_logo").attr("src",host+"/images/sebrae_1.png"),$("#card_widget_logo").attr("src",host+"/images/sebrae_1.png"),$(".send-msg-btn").css("background-image",'url("'+host+'/images/send_btn.png")'),$(".attach-btn").css("background-image",'url("'+host+'/images/paperclip.png")'),$("#form-body").css("background-image",'url("'+host+'/images/sebrae_back.png")');var e=document.getElementById("submit-widget"),t=document.getElementById("initial-widget-btn"),n=document.getElementById("open-form-widget-button"),o=document.getElementById("first-name"),d=document.getElementById("phone-number"),a=document.getElementById("email"),i=document.getElementById("question"),s=document.getElementById("remove-coddera-widget-card-btn"),c=document.getElementById("widget-file-upload"),r={member:{id:""},data:{},typingControl:!0,heartbeatCount:0,operatorConnected:!0};$("#coddera-widget-card").slideToggle("fast"),c.onchange=function(){var e=new FileReader;const t=c.files[0].name,n=c.files[0].type;e.readAsDataURL(c.files[0]),e.onloadend=function(e){var o=new XMLHttpRequest,d={base64:e.target.result,name:t,type:n};o.onloadend=function(){var e="";if(200==this.status){var t=JSON.parse(this.response);e="Segue o link do anexo: "+t.url,sendMsg(e,r.data.id,r.data.member.id,r.data.jwt)}else e="Desculpe houve um erro no envio do anexo.",sendMsg(e,r.data.id,r.data.member.id,r.data.jwt)},o.open("POST",host+"/coddera-widget/aws/uploadS3",!0),o.setRequestHeader("Content-type","application/json"),o.send(JSON.stringify(d))}},document.getElementById("send-msg-btn").onclick=function(){var e=$(".send-msg-txt").val();sendMsg(e,r.data.id,r.data.member.id,r.data.jwt)},t.onclick=function(){$(".initial-card").slideToggle("fast"),$(".card-footer").hide(),$(".custom-card-header").show(),$("#form-body").show()},s.onclick=function(){if(null!=r.data.member){var e=new XMLHttpRequest,t={conversationId:r.data.id,memberId:r.data.member.id,token:r.data.jwt};e.onloadend=function(){widget()},e.open("DELETE",host+"/coddera-widget/chat/finalyze",!0),e.setRequestHeader("Content-type","application/json"),e.send(JSON.stringify(t))}else widget()},n.onclick=function(){$("#coddera-widget-card").slideToggle("fast"),$("#open-form-widget-button").hide()},o.oninput=function(){btnSubmitValidation(o,d,a,i)},d.oninput=function(){btnSubmitValidation(o,d,a,i)},a.oninput=function(){btnSubmitValidation(o,d,a,i)},i.oninput=function(){btnSubmitValidation(o,d,a,i)},e.onclick=function(){$(".card-body").slideToggle("fast"),$(".wait-card").show();var e={name:o.value,phone:d.value.replace(/ /g,""),email:a.value},t=new XMLHttpRequest;t.onloadend=function(){for(;0==this.status;)console.log("wait");if(200==this.status){$(".wait-card").hide(),$(".custom-card-body").slideToggle("fast"),r.data=JSON.parse(this.response).data;var e=new WebSocket(r.data.eventStreamUri,"protocolOne"),t=new Date,n=t.getHours(),o=t.getMinutes();$("#dialog-header").append("<p>Conversa iniciada às "+n+":"+o+". Aguarde, um atendente logo estará disponível</p>"),e.onopen=function(e){sendMsg(i.value,r.data.id,r.data.member.id,r.data.jwt)},e.onmessage=function(t){console.log(t.data);var n=JSON.parse(t.data);switch(n.topicName){case"v2.conversations.chats."+r.data.id+".members":if("ALERTING"==n.eventBody.member.state)r.member.id=n.eventBody.member.id;else if("CONNECTED"==n.eventBody.member.state&&r.member.id==n.eventBody.member.id)$(".custom-card-footer").show(),document.getElementById("send-msg-txt").oninput=function(){var e=new XMLHttpRequest,t={conversationId:r.data.id,memberId:r.data.member.id,token:r.data.jwt};e.onloadend=function(){console.log("Response Code: "+this.status),console.log("Response: "+this.response)},e.open("POST",host+"/coddera-widget/chat/send-typing",!0),e.setRequestHeader("Content-type","application/json"),e.send(JSON.stringify(t))},r.operatorConnected&&($(".chat-dialog").append("<p>O operador acabou de se connectar.</p>"),r.operatorConnected=!1);else if("DISCONNECTED"==n.eventBody.member.state&&r.member.id==n.eventBody.member.id){e.close(),$(".custom-card-footer").hide(),$(".chat-dialog").append("<p>O chat foi encerrado. Obrigado pelo contato.</p>");var o=document.getElementById("block-typing");null!=o&&(o.parentNode.removeChild(o),r.typingControl=!0)}break;case"v2.conversations.chats."+r.data.id+".messages":var d="";if("typing-indicator"==n.metadata.type&&r.typingControl&&r.member.id==n.eventBody.sender.id&&(d+='<div class="block-dialog"  id="block-typing">',d+=' <div class="typing-msg">',d+='  <div class="typing">',d+='   <div class="dot"></div>',d+='   <div class="dot"></div>',d+='   <div class="dot"></div>',d+="  </div>",d+=" </div>",d+='<div class="agent-name">Digitando</div>',d+="</div>",$(".chat-dialog").append(d),document.getElementById("chat-body").scrollTo(0,document.getElementById("chat-body").scrollHeight),r.typingControl=!1,r.heartbeatCount=0),"message"==n.metadata.type&&r.member.id==n.eventBody.sender.id&&""!=n.eventBody.body&&r.member.id==n.eventBody.sender.id&&""!=n.eventBody.body){d+='<div class="block-dialog"  id="block-agent">',d+='<div class="agent-msg">',d+=n.eventBody.body,d+="</div>",d+='<div class="agent-name">Atendente</div>',d+="</div>",$(".chat-dialog").append(d);o=document.getElementById("block-typing");null!=o&&(o.parentNode.removeChild(o),r.typingControl=!0),document.getElementById("chat-body").scrollTo(0,document.getElementById("chat-body").scrollHeight)}break;case"channel.metadata":if("WebSocket Heartbeat"==n.eventBody.message&&(r.heartbeatCount+=1,2==r.heartbeatCount)){var a=document.getElementById("chat-dialog");if(a.querySelector("#block-typing")){o=document.getElementById("block-typing");o.parentNode.removeChild(o),r.typingControl=!0}r.heartbeatCount=0}}}}else console.log(">>>>>>>> CREATE CHAT ERROR: "+this.response)},t.open("POST",host+"/coddera-widget/chat/create",!0),t.setRequestHeader("Content-type","application/json"),t.send(JSON.stringify(e))}})}function btnSubmitValidation(e,t,n,o){$("#form-group").css("border-bottom","2px solid #FCAF17"),""!=e.value&&""!=t.value&&""!=n.value&&""!=o.value?$("#submit-widget").prop("disabled",!1):$("#submit-widget").prop("disabled",!0)}function sendMsg(e,t,n,o){var d={conversationId:t,memberId:n,token:o,msg:e,bodyType:"standard"},a=new XMLHttpRequest;a.onloadend=function(){if(200==this.status){var t="";""!=e&&(t+='<div class="block-dialog"  id="block-client">',t+='<div class="client-msg">',t+=e,t+="</div>",t+='<div class="client-name">Você</div>',t+="</div>",$(".chat-dialog").append(t)),document.getElementById("chat-body").scrollTo(0,document.getElementById("chat-body").scrollHeight),$(".send-msg-txt").val("")}else console.log(">>>>>>>> SEND MESSAGE ERROR: "+this.response)},a.open("POST",host+"/coddera-widget/chat/send",!0),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(d))}const host="https://genesyscloudapps.coddera.com:3000";widget();